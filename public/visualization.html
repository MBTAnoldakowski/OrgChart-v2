<div id="option">

    <h1>MBTA Organization Chart</h1>
    <div class="lastUpdated">
        <p>Last Updated: 9/22/2017 3:25PM</p>
    </div>
    <div class="update">
        <a class="btn btn-warning" href="#!/update">Update</a>
    </div>
    <br/>
    <input name="updateButton"
           type="button"
           class="btn btn-default"
           value="View Operating"
           onclick="updateData()"/>

    <input name="updateButton"
           type="button"
           class="btn btn-default"
           value="View Administration"
           onclick="updateData2()"/>


</div>
<!-- this is an empty div for the script to populate with the tree -->
<div id="chart"></div>
<script>
    // clears the screen in case the employee visualization is still loaded
    d3.select("svg").remove();

    // sizes the box to paint in
    var margin = {top: 20, right: 150, bottom: 20, left: 200},
        width = 1000,
        height = 1300;

    // honestly, I am not 100% sure what the next few declarations actually do specifically.
    // I do know that they are very important though. They initialize the tree
    var i = 0,
        duration = 750,
        root;

    var tree = d3.layout.tree()
        .size([height, width]);

    var diagonal = d3.svg.diagonal()
        .projection(function (d) {
            return [d.y, d.x];
        });

    var svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 1e-6);

    // loads in the CSV with the budgeting data in it
    var buData = [];

    d3.csv("csv/budgetdata.csv", function (error, bData) {
        if (error) throw error;
        bData.forEach(function (b) {
            //the + next to the following makes d3 think of it as a number
            b.deptNo = +b.deptNo;
            b.year = +b.year;
            b.budgetAmount = +parseFloat(b.budgetAmount);
            b.actualsAmount = +parseFloat(b.actualsAmount);
            //adds all of the budget data to the array that I initialized above.
            buData.push(b);
        });
    });

    //loads the department data
    d3.json("resources/flare_experiment_2.json", function (error, flare) {
        if (error) throw error;

        root = flare;
        root.x0 = height / 2;
        root.y0 = 0;

        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
            }
            //  console.log("D: " + d);
        }

        //root.children.forEach(collapse);
        root.children.forEach(collapse);
        update(root);
        setTimeout(function () {
            expandAll();
        }, 100)
    });


    d3.select(self.frameElement).style("height", "800px");

    function update(source) {

        // Compute the new tree layout.
        var nodes = tree.nodes(root).reverse(),
            links = tree.links(nodes);

        // Normalize for fixed-depth.
        nodes.forEach(function (d) {
            d.y = d.depth * 250;    // I don't know specifically what this does,
                                    // but I do know that changing the number
                                    // changes the width of the tree that is displayed
        }); //180

        // Update the nodes
        var node = svg.selectAll("g.node")
            .data(nodes, function (d) {
                return d.id || (d.id = ++i);
            });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", function (d) {
                return "translate(" + source.y0 + "," + source.x0 + ")";
            })
            .on("click", click);

        nodeEnter.append("circle")
            .attr("r", 1e-6);

        nodeEnter.append("text")
            .attr("x", function (d) {
                return d.children || d._children ? -10 : 10;
            })
            .attr("dy", ".35em")
            .attr("text-anchor", function (d) {
                return d.children || d._children ? "end" : "start";
            })
            //the name is appended to the dot right here
            .text(function (d) {
                return d.name;
            })
            .on("mouseover", mouseover)
            .on("mousemove", function (d) {
                mousemove(d);
            })
            .on("mouseout", mouseout)
            .style("fill-opacity", 1e-6)
            // the names are styled here.
            .style("fill", function (d) {
                var budget = getBudgetData(d.deptno);
                var actual = getBudgetActuals(d.deptno);
                var date = new Date();
                var month = getFiscalDay() / 365;
                console.log(month);
                var ytd = budget * month;
                console.log(ytd);
                var dec = 0;

                if (budget != undefined && actual != undefined) {

                    if (budget != 0) {
                        console.log(d.name);
                        dec = (actual - ytd) / ytd;
                        console.log(dec);
                        if (dec >= -0.1 && dec <= 0.1) {
                            console.log('in range');
                            return "#32CD32";
                        }
                        if (dec <= -0.1 && dec > -0.25) {
                            console.log("slightly underspending");
                            return "#5FB7C9";
                        }
                        if (dec < -0.25) {
                            console.log("underspending");
                            return "#4B0082";
                        }
                        if (dec > 0.1 && dec <= 0.25) {
                            console.log("slightly over");
                            return "#FF9999";

                        }
                        if (dec > 0.25) {
                            console.log("overspending");
                            return "red";
                        }
                    }
                    if (budget == 0 && actual > 0) {
                        console.log(d.deptno);
                        return "red"
                    }
                    if (actual == 0) {
                        console.log("underspending");
                        return "#4B0082";
                    }
                }
                return "black";

                //return returnColor(budget, actual, ytd);
            });

        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function (d) {
                return "translate(" + d.y + "," + d.x + ")";
            });

        // size/style the circles
        nodeUpdate.select("circle")
            .attr("r", function (d) {
                return 6;
            })
            .style("fill", function (d) {
                if (d.level == "2") return "red";
                if (d.level == "3") return "orange";
                if (d.level == "4") return "green";
                if (d.level == "5") return "blue";
                if (d.level == "6") return "purple";
                if (d.name == "") return "#ffffff";
            })
            .style("opacity", function (d) {
                if (d.level == "") {
                    return 0;
                }
            });

        nodeUpdate.select("text")
            .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function (d) {
                return "translate(" + source.y + "," + source.x + ")";
            })
            .remove();

        nodeExit.select("circle")
            .attr("r", 1e-6);

        nodeExit.select("text")
            .style("fill-opacity", 1e-6);

        // Update the linksâ€¦
        var link = svg.selectAll("path.link")
            .data(links, function (d) {
                return d.target.id;
            });

        // Enter any new links at the parent's previous position.
        link.enter().insert("path", "g")
            .attr("class", "link")
            .attr("d", function (d) {
                var o = {x: source.x0, y: source.y0};
                return diagonal({source: o, target: o});
            });

        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", diagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function (d) {
                var o = {x: source.x, y: source.y};
                return diagonal({source: o, target: o});
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function (d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    // Toggle children on click.
    function click(d) {
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
        update(d);
    }

    function mouseover() {
        div.transition()
            .duration(300)
            .style("opacity", 1);
    }

    //draws the tooltip
    function mousemove(d) {
        var deptNo = d.deptno;
        if (d.approval1 != undefined) {
            div.html(d.deptno + "<br/>" + "Level 1: " + d.approval1 + "<br/>" + "Level 2: " + d.approval2 + "<br/>"
                + "Level 3: " + d.approval3 + "<br/>" + "Level 4: " + d.approval4 + "<br/>" + "Level 5: " + d.approval5
                + "<br/>" + "Level 6: " + d.approval6 + "<br/>" + "Level 7: " + d.approval7 + "<br/>" + "Level 8: "
                + d.approval8)
                .style("left", (d3.event.pageX ) + "px")
                .style("top", (d3.event.pageY) + "px");
        }
        /*if(d.level == "" && d.deptno == ""){
            div.html("<br/>")
        }*/
        if (getBudgetData(d.deptno) != undefined) {
            div.html(d.deptno + "<br/> Approves at a higher level" + "<div align = 'right'> Budget: " + formatMoney(getBudgetData(d.deptno))
                + "<br/> Actual: " + formatMoney(getBudgetActuals(d.deptno)) + "<br/> YTD Budget: " + YTDbudget(getBudgetData(d.deptno)) + "</div>")
                .style("left", (d3.event.pageX ) + "px")
                .style("top", (d3.event.pageY) + "px");
        }

        if (d.approval1 == undefined && getBudgetData(d.deptno) == undefined) {
            div.html(d.deptno + "<br/> Approves at a higher level")
                .style("left", (d3.event.pageX ) + "px")
                .style("top", (d3.event.pageY) + "px");
        }

    }

    //helper function to get YTD
    function YTDbudget(budgetTotal) {
        var date = new Date();
        var month = getFiscalDay();
        var p = month / 365;
        var ytd = budgetTotal * p;
        console.log("YTD: " + ytd);
        return formatMoney(ytd);
    }

    //helper function for formatting money in the tooltip
    function formatMoney(number) {
        var oldNum = parseFloat(number);
        // console.log(oldNum);
        var num = '$' + oldNum.toFixed(0).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");

        return num;
    }

    function getFiscalMonth(month) {
        var fMonth;
        // console.log(month);
        switch (month) {
            case 6:
            case 7:
            case 8:
            case 9:
            case 10:
            case 11:
                fMonth = month - 6;
                break;
            case 0:
            case 1:
            case 2:
            case 3:
            case 4:
            case 5:
                fMonth = month + 6;
                break;
            default:
                console.log("SOMETHING IS WRONG...");
        }
        return fMonth;

    }

    function getFiscalDay() {
        var date = new Date();
        var year = date.getFullYear();
        console.log(year);
        switch (date.getMonth()) {
            case 0:
            case 1:
            case 2:
            case 3:
            case 4:
            case 5:
                year = year - 1;
                break;
            default:
                console.log("before new real year");
        }
        var day = date.getDate();
        var startOfFiscalYear = new Date("July 1, " + year + " 12:00:00");
        var utc1 = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
        var utc2 = Date.UTC(startOfFiscalYear.getFullYear(), startOfFiscalYear.getMonth(), startOfFiscalYear.getDate());
        return Math.floor(Math.abs(utc2 - utc1) / (1000 * 60 * 60 * 24));
    }

    // controls how slowly the tooltip disappears
    function mouseout() {
        div.transition()
            .duration(300)
            .style("opacity", 1e-6);
    }

    // I have had so much trouble with this function for whatever reason
    // It gets the budget for a specific department
    function getBudgetData(department) {
        var dept = parseFloat(department);
        // console.log(dept);
        for (var i in buData) {
            // console.log(i);
            if (parseFloat(buData[i].deptNo) === dept) {
                //   console.log(i);
                return buData[i].budgetAmount;
            }
        }

    }

    // This gets the actuals for a specific department
    function getBudgetActuals(department) {
        var dept = parseFloat(department);
        //console.log(dept);
        for (var i in buData) {

            if (parseFloat(buData[i].deptNo) === dept) {
                //  console.log(i);
                return buData[i].actualsAmount;
            }
        }
    }

    // this is triggered when you hit the 'View Operating' button, it just loads the
    // Operating data instead of the Administration data
    function updateData() {
        d3.json("resources/flare_experiment.json", function (error, flare) {
            if (error) throw error;

            root = flare;
            root.x0 = height / 2;
            root.y0 = 0;

            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }

            //UNCOMMENT below if you would like the nodes to all be collapsed on start.
            //root.children.forEach(collapse);
            update(root);
        });

    }

    // this function updates the data to display administration
    function updateData2() {
        d3.json("resources/flare_experiment_2.json", function (error, flare) {
            if (error) throw error;

            root = flare;
            root.x0 = height / 2;
            root.y0 = 0;

            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }

            //root.children.forEach(collapse);
            update(root);
        });

    }


    function expand(d) {
        var children = (d.children) ? d.children : d._children;
        if (d._children) {
            d.children = d._children;
            d._children = null;
        }
        if (children)
            children.forEach(expand);
    }

    //expands all nodes in the tree
    function expandAll() {
        expand(root);
        update(root);
    }

</script>
<!--Circle Legend-->
<div id="legend">
    <h3 class="ltitle">Legend</h3>
    <div id="level1circle"></div>
    <p>Level 1 is MBTA</p>
    <div id="level2circle"></div>
    <p>Level 2</p>
    <div id="level3circle"></div>
    <p>Level 3</p>
    <div id="level4circle"></div>
    <p>Level 4</p>
    <div id="level5circle"></div>
    <p>Level 5</p>
    <div id="level6circle"></div>
    <p>Level 6</p>

</div>
<!--Projected Budget-->
<div class="ltitleright">
    <h3 class="ltitle">Projected Budget Key</h3>
    <p id="over">Over Budget (>25%)</p>
    <p id="slightlyover">Slightly Overspending (10 to 25%)</p>
    <p id="lessthan25">On Target (-10 to 10%) </p>
    <p id="slightlyunder">Slightly Underspending (-25 to -10%)</p>
    <p id="under">Under Budget (<-25%)</p>
</div>

<!--Expand Button -->
<div id="expandB">
    <input name="expandButton"
           type="button"
           class="btn"
           id="expandB"
           value="Expand All"
           onclick="expandAll()"/>
</div>
<!--Switch to Employee Page button-->
<div id="employeeButton" class="btn-group-vertical">
    <a class="btn btn-default"  href="#!/kpi">KPI Chart</a>
    <a class="btn btn-default" href="#!/procurement">Procurement Chart</a>
    <a class="btn btn-primary disabled" href="#!/">Budget Chart</a>
    <a class="btn btn-default" href="#!/employees">Employee Chart</a>


</div>